set -euo pipefail

echo "ğŸ”§ Creating SFS Auto-Git Workflow..."

# [1] Create auto-commit script
cat > ~/sfs-auto-commit.sh << 'EOFSCRIPT'
#!/bin/bash
set -euo pipefail

echo "ğŸš€ SFS Auto-Commit Starting..."

# Check if we're in a git repo
if [ ! -d .git ]; then
  echo "âŒ Not in a git repository"
  exit 1
fi

# Stage all changes
git add -A
echo "âœ… Staged all files"

# Generate commit message based on changed files
CHANGED_FILES=$(git diff --cached --name-only | head -5 | tr '\n' ', ' | sed 's/,$//')
TIMESTAMP=$(date '+%Y-%m-%d %H:%M')

if [ -z "$CHANGED_FILES" ]; then
  echo "â„¹ï¸  No changes to commit"
  exit 0
fi

# Create smart commit message
COMMIT_MSG="feat: Updated $CHANGED_FILES - $TIMESTAMP"

# Commit
git commit -m "$COMMIT_MSG"
echo "âœ… Committed: $COMMIT_MSG"

# Pull latest (rebase to avoid merge commits)
echo "â¬‡ï¸  Pulling latest changes..."
git pull --rebase origin $(git branch --show-current) || {
  echo "âš ï¸  Pull had conflicts, attempting to resolve..."
  git rebase --abort 2>/dev/null || true
  git pull origin $(git branch --show-current)
}

# Push
echo "â¬†ï¸  Pushing to GitHub..."
git push origin $(git branch --show-current)

echo "ğŸ‰ Done! All changes synced to GitHub"
EOFSCRIPT

chmod +x ~/sfs-auto-commit.sh
echo "âœ… [1] Auto-commit script created"

# [2] Create quick alias
cat >> ~/.bashrc << 'EOFALIAS'

# SFS Quick Commit - just type "sfs" to commit and push everything
alias sfs='~/sfs-auto-commit.sh'
alias sfs-sync='cd ~/workspace && ~/sfs-auto-commit.sh'
EOFALIAS

source ~/.bashrc 2>/dev/null || true
echo "âœ… [2] Aliases added"

# [3] Create .replit workflow button
cat > .replit << 'EOFREPLIT'
run = "npm run dev"

[deployment]
run = ["sh", "-c", "npm run dev"]

[[ports]]
localPort = 5000
externalPort = 80

[workflows]
[[workflows.steps]]
name = "ğŸš€ Commit & Push All Changes"
command = "bash ~/sfs-auto-commit.sh"
EOFREPLIT

echo "âœ… [3] Replit workflow button added"

# [4] Run it now to commit current changes
cd ~/workspace
echo ""
echo "ğŸ“¦ Committing your current changes..."
bash ~/sfs-auto-commit.sh

echo ""
echo "ğŸ‰ WORKFLOW SETUP COMPLETE!"
echo ""
echo "Usage (3 ways):"
echo "  1. Type: sfs                    (from anywhere)"
echo "  2. Type: sfs-sync               (commits workspace)"
echo "  3. Click workflow button in Replit UI"
echo ""
echo "What it does:"
echo "  âœ… Stages all changes (git add -A)"
echo "  âœ… Creates smart commit message with files + timestamp"
echo "  âœ… Commits changes"
echo "  âœ… Pulls latest from GitHub"
echo "  âœ… Pushes to GitHub"
echo ""